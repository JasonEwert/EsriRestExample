<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ArcServer ReST API Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="http://dl.dropbox.com/u/1139822/bootstrap.css" rel="stylesheet">
	<!-- <link rel="stylesheet" href="leaflet-0.4.2/dist/leaflet.css" /> -->
	<link rel="stylesheet" href="https://dl.dropboxusercontent.com/u/1139822/Leaflet/dist/leaflet.css" />

    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href='http://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
 

    <style type="text/css">
		h1#big {
			font-family: 'Gorditas', cursive;
			color: #000000;
			font-size: 60px;
			line-height: 60px;
			text-align: center;
		}

		h2#medium {
			font-family: sans-serif;
			font-size: 20px;
			color: #444;
			margin-left: 470px;
			margin-bottom: 50px;
		}

		label.label {
			font-size: 20px;
			line-height: 30px;
		}

		#options {
			text-align: center;
		}
</style>

	
  </head>

  <body>
     <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="http://pca-gis02.pca.state.mn.us/ArcGIS/rest/services">Using ArcGIS for Server ReST API</a>
        </div>
      </div>
    </div>
	
	<div class="container">
	
	<img src='https://dl.dropboxusercontent.com/u/975922/Bikes/11212012431.jpg'>this is a test</img>

        <div class="span12">
            <div class="row" id="options">
			  <h1 id='big'>Wastewater Treatment Facilities</h1> 
			  <h2 id='medium'>by the Minnesota Pollution Control Agency</h2>
			    <div id="map" style="width: 600px; height: 400px">
				</div>
			  <br/>	
			  <h2 id='big'>where facility_name LIKE '%WWTP%'</h2> 
			  <br/>	
			  <h3 id='big'>http://pca-gis02.pca.state.mn.us/arcgis/rest/services/agol/phosloads/MapServer/0/query?where=Facility_N+LIKE+%27%25WWTP%25%27...outFields=*</h3> 
            </div>
			<br/>
			<h1 id='big'> list the results </h1>
			<br/>
			<div id="list" style="padding-left: 200px">
				<ul id="sites"></ul>
			</div>
			
		</div>
	</div>
  
	<!-- jQuery -->  
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!-- leaflet --> 
	<script src="https://dl.dropboxusercontent.com/u/1139822/Leaflet/dist/leaflet-src.js"></script>
	<!--<script src="leaflet-0.4.2/dist/leaflet.js"></script>-->
	<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.1.2"></script>
	<script>

		$(document).ready(function (){

		  var route = "http://pca-gis02.pca.state.mn.us/arcgis/rest/services/agol/phosloads/MapServer/0/query?where=Facility_N+LIKE+%27%25WWTP%25%27+&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=4326&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson"

		  $.ajax({

			type: 'GET',
			url: route,
			async: false,
			jsonpCallback: 'obj',
			contentType: "application/json",
			dataType: 'jsonp',
			success: function (obj) {
				
			  (function ($) {
		 
				// create the map and add the stamen layers
				// replace "toner" here with "terrain" or "watercolor"
				var layer = new L.StamenTileLayer("terrain");
				var map = new L.Map("map", {
					center: new L.LatLng(44.819, -93.596),
					zoom: 10
				});
				map.addLayer(layer);

				// create markers		
				for (i=0;i < obj.features.length;i++){
				
					if (obj.features[i].geometry.y > 0) {
											
						var markerLocation = new L.LatLng(obj.features[i].geometry.y, obj.features[i].geometry.x),
							marker = new L.Marker(markerLocation);
						
						map.addLayer(marker);
						
						marker.bindPopup(
							"<center><h3>" 
							+ obj.features[i].attributes.Facility_N 
							+ "</h3><br /> This facility is currently discharging "
							+ obj.features[i].attributes.phos_curre.toFixed(0) 
							+ " kg of phosphorus per year.</center>"
						);
					
						$('#sites').append("<li>" + obj.features[i].attributes.Facility_N + "</li>"); 
					};
				};

			  })(jQuery);

			},
			error: function (e) {
			  console.log(e.message);
			  alert("unable to connect to data");
			}
		  });

		});

	</script>
  </body>
</html>
